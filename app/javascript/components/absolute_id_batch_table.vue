<template>
  <div>
    <div>
      <grid-container>
        <grid-item columns="lg-12 sm-12">
          <header>{{ header }}</header>
          <form class="absolute-ids-sync-form" :action="synchronizeAction" :method="synchronizeMethod">
            <button
              data-v-b7851b04
              class="lux-button solid lux-button absolute-ids-sync-form--submit"
              :disabled="synchronizing"
              @click.prevent="onSynchronizeSubmit">{{ synchronizeLabel }}</button>
          </form>

          <a
            data-v-b7851b04
            :href="sessionIdPath"
            class="lux-button solid lux-button absolute-ids-sync-form--submit">Report</a>
        </grid-item>

      </grid-container>
    </div>

    <absolute-id-table
      v-for="batch in session.batches"
      :key="batch.id"
      :caption="batch.label"
      :columns="columns"
      :json-data="batch.tableData"
      :token="token"
      :synchronize-action="synchronizeAction"
    ></absolute-id-table>
  </div>
</template>

<script>
import AbsoluteIdTable from './absolute_id_table'

/**
 * Used to display data to end users.
 */
export default {
  name: "AbsoluteIdBatchTable",
  status: "prototype",
  release: "1.0.0",
  type: "Element",
  components: {
    "absolute-id-table": AbsoluteIdTable
  },
  props: {
    header: {
      required: true,
      type: String,
    },

    token: {
      required: true,
      type: String
    },

    columns: {
      required: true,
      type: Array
    },

    session: {
      required: true,
      type: Object
    },

    synchronized: {
      type: Boolean,
      default: true
    },

    synchronizeAction: {
      type: String,
      default: '/absolute-ids/synchronize'
    },

    synchronizeMethod: {
      type: String,
      default: 'POST'
    },

    sessionIdPath: {
      type: String,
      default: ''
    }
  },
  data() {
    return {
      rows: this.jsonData,
      parsedColumns: [],
      synchronizing: !this.synchronized
    }
  },
  computed: {
    synchronizeLabel: function() {

      let output = 'Synchronize';
      if (this.synchronizing) {
        output = 'Synchronizing';
      }

      return output;
    }
  },
  methods: {
    postData: async function () {
      const response = await fetch(this.synchronizeAction, {
        method: this.synchronizeMethod,
        mode: 'cors',
        cache: 'no-cache',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.token}`
        },
        redirect: 'follow',
        referrerPolicy: 'no-referrer'
      });

      return response;
    },
    onSynchronizeSubmit: async function (event) {
      event.target.disabled = true;

      this.synchronizing = true;
      const response = await this.postData();

      event.target.disabled = false;
      if (response.status === 302) {
        const redirectUrl = response.headers.get('Content-Type');
        window.location.assign(redirectUrl);
      } else {
        window.location.reload();
      }
    }
  }
}
</script>

<style lang="scss" scoped>
@import "../../../node_modules/lux-design-system/dist/system/system.utils.scss";

.lux-data-table {
  border-collapse: collapse;
  border-spacing: 0;
  border-left: none;
  border-right: none;
  border-bottom: none;

  caption {
    @include stack-space($space-base);
    display: table-caption;
    text-align: left;
    @include responsive-font(
      2vw,
      $font-size-x-large-min,
      $font-size-x-large-max,
      $font-size-x-large
    );
    font-weight: $font-weight-bold;
    font-family: $font-family-text;
    line-height: $line-height-heading;
  }

  thead {
    display: table-header-group;
    vertical-align: middle;
  }

  thead tr {
    background-color: $color-grayscale-lighter;
    color: $color-rich-black;
  }

  th {
    line-height: 22px;
    padding: 20px;
    font-weight: $font-weight-semi-bold;
    font-family: $font-family-text;
    font-size: $font-size-x-small;
    line-height: $line-height-heading;
    text-align: left;
    text-transform: uppercase;
    color: $color-grayscale-darker;
    letter-spacing: 0.5px;
  }

  th,
  td {
    border-bottom: none;
    border-left: none;
    border-right: none;
    border-top: 1px solid darken($color-grayscale-lighter, 10%);
    @include inset-space($space-base);
    overflow: hidden;
  }

  th button {
    padding: 0px;
    font-weight: $font-weight-semi-bold;
    font-family: $font-family-text;
    font-size: $font-size-x-small;
    line-height: $line-height-heading;
    text-align: left;
    text-transform: uppercase;
    color: $color-grayscale-darker;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    margin: 0;

    /deep/ .lux-icon {
      display: initial;
    }
  }

  tbody tr {
    display: table-row;
    vertical-align: inherit;
    background-color: $color-white;
    color: $color-grayscale-darker;

    &:hover {
      background: $color-grayscale-warm-lighter;

      input {
        background: $color-grayscale-warm-lighter;
      }
    }
  }

  tbody {
    background-color: #fff;
  }

  td {
    color: $color-rich-black;
    font-weight: $font-weight-regular;
    font-family: $font-family-text;
    font-size: $font-size-base;
    line-height: 1.2;
    text-align: left;

    input {
      position: relative;
      width: auto;
      cursor: pointer;

      &:hover,
      &:focus,
      &:checked {
        box-shadow: none;
        border: 0;
      }
    }

    input::before,
    input::after {
      position: absolute;
      content: "";

      /*Needed for the line-height to take effect*/
      display: inline-block;
    }

    /*Outer box of the fake checkbox*/
    input::before {
      height: 16px;
      width: 16px;
      background-color: $color-white;
      border: 0;
      border-radius: $border-radius-default;
      box-shadow: inset 0 1px 0 0 rgba($color-rich-black, 0.07),
        0 0 0 1px tint($color-rich-black, 80%);
      left: 0;
      top: 4px;
    }

    /* On mouse-over, add a grey background color */
    input:not([disabled]):hover::before {
      box-shadow: 0 1px 5px 0 rgba($color-rich-black, 0.07), 0 0 0 1px tint($color-rich-black, 60%);
    }

    input:checked::before {
      transition: box-shadow 0.2s ease;
      background-color: $color-bleu-de-france;
      box-shadow: inset 0 0 0 1px $color-bleu-de-france, 0 0 0 1px $color-bleu-de-france;
      outline: 0;
    }

    /*Checkmark of the fake checkbox*/
    input::after {
      height: 5px;
      width: 10px;
      border-left: 2px solid $color-white;
      border-bottom: 2px solid $color-white;

      transform: rotate(-45deg);

      left: 3px;
      top: 7px;
    }

    /*Hide the checkmark by default*/
    input[type="checkbox"]::after {
      content: none;
    }

    /*Unhide on the checked state*/
    input[type="checkbox"]:checked::after {
      content: "";
    }

    /*Adding focus styles on the outer-box of the fake checkbox*/
    input[type="checkbox"]:focus::before {
      transition: box-shadow $duration-quickly ease;
      box-shadow: inset 0 0 0 1px $color-bleu-de-france, 0 0 0 1px $color-bleu-de-france;
    }
  }

  .lux-data-table-currency {
    text-align: right;
  }

  .lux-data-table-currency > span::before {
    content: "$";
  }

  .lux-data-table-number {
    text-align: right;
  }

  .lux-data-table-left {
    text-align: left;
  }

  .lux-data-table-center {
    text-align: center;
  }

  .lux-data-table-right {
    text-align: right;
  }
}
</style>

<docs>
  ```jsx
  <data-table caption="Staff Emails" summary-label="Average"
    :columns="[
      { 'name': 'id', 'display_name': 'Select Items', 'align': 'center', 'checkbox': true },
      'name',
      { 'name': 'email', 'display_name': 'Email Address', 'align': 'center', 'sortable': true },
      { 'name': 'birthday', 'datatype': 'date', 'sortable': true },
      { 'name': 'age', 'datatype': 'number', 'summary_value': '33', 'sortable': true }
    ]"
    :json-data="[
      {'id': 1,'name': { value: 'foo', link: 'https://library.princeton.edu'},'email': 'foo@xxx.xxx', 'age': 30, 'birthday': 'March 4, 1989' },
      {'id': 2,'name': 'bar','email': 'bar@xxx.xxx', 'age': 44, 'birthday': 'October 4, 1975' },
      {'id': 3,'name': 'fez','email': 'fez@xxx.xxx', 'age': 19, 'birthday': 'May 14, 2000' },
      {'id': 4,'name': 'hey','email': 'hey@xxx.xxx', 'age': 19 , 'birthday': 'May 5, 2000'},
    ]"/>
  ```
</docs>
